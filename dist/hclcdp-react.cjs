"use strict";"use client";var P=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var W=(e,t)=>{for(var i in t)P(e,i,{get:t[i],enumerable:!0})},X=(e,t,i,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of J(t))!B.call(e,o)&&o!==i&&P(e,o,{get:()=>t[o],enumerable:!(n=$(t,o))||n.enumerable});return e};var Z=e=>X(P({},"__esModule",{value:!0}),e);var re={};W(re,{CdpClientWrapper:()=>oe,CdpContextProvider:()=>T,CdpPageEvent:()=>se,CdpProvider:()=>x,Facebook:()=>R,GoogleAnalytics:()=>L,useCdp:()=>U,useCdpContext:()=>ne});module.exports=Z(re);var I=require("uuid"),O=require("ua-parser-js"),_=require("uuid"),b={name:"@hcl-cdp-ta/hclcdp-web-sdk",version:"0.0.12",description:"HCL CDP Web SDK",keywords:["HCLCDP"],repository:{type:"git",url:"git+https://github.com/HCL-CDP-TA/hclcdp-web-sdk.git"},license:"MIT",author:"Simon Pallister",type:"module",main:"./dist/hclcdp-web.js",scripts:{build:"tsup",dev:"tsup --watch"},dependencies:{axios:"^1.7.9","ua-parser-js":"^2.0.2",uuid:"^11.0.5"},devDependencies:{tsup:"^8.3.6",typescript:"^5.7.3",terser:"^5.39.0"}},ee=class{profileId;deviceId;userId=null;context=null;config={writeKey:"",cdpEndpoint:"",inactivityTimeout:30,enableSessionLogging:!1};CDP_STORAGE_KEY="hclcdp_identity_data";SESSION_ID="hclcdp_session_id";constructor(){console.log("\u{1F6A8} CDPCLIENT CONSTRUCTOR CALLED \u{1F6A8}"),console.log("\u{1F4E6} SDK Version:",b.version),console.log("\u{1F550} Constructor timestamp:",new Date().toISOString()),console.log("CdpClient constructor - starting ID initialization"),this.migrateOldLocalStorageData();let e=this.getStoredIdentityData();this.profileId=e.profileId||this.createProfileId(),console.log("Profile ID initialized:",this.profileId),this.deviceId=e.deviceId||this.createDeviceId(),console.log("Device ID initialized:",this.deviceId),this.userId=e.userId||null,console.log("User ID initialized:",this.userId),this.saveIdentityData(),console.log("CdpClient constructor - ID initialization complete")}init=async e=>{this.config=e,console.log("init",e);let t=(0,O.UAParser)(window.navigator.userAgent);this.context={library:{name:b.name,type:"javascript",version:b.version},userAgent:{deviceType:t.device.type||"Desktop",osType:t.os.name||"",osVersion:t.os.version||"",browser:t.browser.name||"",ua:t.ua}}};page=async(e,t,i,n,o)=>{this.context&&n&&(this.context.utm=n);let a={type:"page",event:"page_view",name:e,id:this.profileId,deviceId:this.deviceId,userId:this.userId||"",deviceType:this.context?.userAgent.deviceType||"Unknown",originalTimestamp:Date.now(),sessionId:t,messageId:(0,I.v4)(),writeKey:this.config.writeKey||"",otherIds:{...o},context:this.context||{library:{name:"",type:""},userAgent:{deviceType:"",osType:"",osVersion:"",browser:"",ua:""}},properties:{...i}};this.sendPayload(a)};track=async(e,t,i,n)=>{this.context&&(this.context.page={path:window.location.pathname,url:window.location.href,referrer:document.referrer,title:document.title,search:document.location.search});let o={type:"track",event:e,id:this.profileId,deviceId:this.deviceId,userId:this.userId||"",deviceType:this.context?.userAgent.deviceType||"Unknown",originalTimestamp:Date.now(),sessionId:t,messageId:(0,I.v4)(),writeKey:this.config.writeKey||"",otherIds:{...n},context:this.context,properties:{...i}};console.log("Tracking event...",o),this.sendPayload(o)};identify=async(e,t,i,n)=>{this.setUserId(e);let o={type:"identify",event:"identify_event",userId:e,id:this.profileId,deviceId:this.deviceId,deviceType:this.context?.userAgent.deviceType||"Unknown",originalTimestamp:Date.now(),sessionId:t,messageId:(0,I.v4)(),writeKey:this.config.writeKey||"",otherIds:{...n},context:this.context||{library:{name:"",type:""},userAgent:{deviceType:"",osType:"",osVersion:"",browser:"",ua:""}},customerProperties:{...i}};console.log("Identify event...",o),this.sendPayload(o)};login=async(e,t,i,n,o="User_login")=>{console.log("Logging in user",this.userId),this.identify(e,t,i,n),this.config.enableUserLogoutLogging&&this.track(o,t,i,n),this.setUserId(e)};logout=async e=>{this.config.enableUserLogoutLogging&&this.track("User_logout",e),this.removeUserId()};setUserId=e=>{this.userId=e||null,this.saveIdentityData()};removeUserId=()=>{this.userId=null,localStorage.removeItem(this.SESSION_ID),this.profileId=this.createProfileId(),this.saveIdentityData()};migrateOldLocalStorageData=()=>{if(console.log("migrateOldLocalStorageData - checking for old format data"),localStorage.getItem(this.CDP_STORAGE_KEY)){console.log("migrateOldLocalStorageData - new format already exists, skipping migration");return}let e=localStorage.getItem("hclcdp_profile_id")||localStorage.getItem("hclcdp_device_id"),t=localStorage.getItem("hclcdp_device_id"),i=localStorage.getItem("hclcdp_user_id");if(e||t||i){console.log("migrateOldLocalStorageData - found old format data, migrating..."),console.log("Old Profile ID:",e),console.log("Old Device ID:",t),console.log("Old User ID:",i);let n={profileId:e||void 0,deviceId:t||void 0,userId:i||void 0};localStorage.setItem(this.CDP_STORAGE_KEY,JSON.stringify(n)),console.log("migrateOldLocalStorageData - migrated data:",n),localStorage.removeItem("hclcdp_profile_id"),localStorage.removeItem("hclcdp_device_id"),localStorage.removeItem("hclcdp_user_id"),console.log("migrateOldLocalStorageData - cleaned up old format keys")}else console.log("migrateOldLocalStorageData - no old format data found")};getStoredIdentityData=()=>{console.log("getStoredIdentityData - checking localStorage for key:",this.CDP_STORAGE_KEY);let e=localStorage.getItem(this.CDP_STORAGE_KEY);if(console.log("getStoredIdentityData - found in localStorage:",e),!e)return console.log("getStoredIdentityData - no existing data, returning empty object"),{};try{let t=JSON.parse(e);return console.log("getStoredIdentityData - parsed data:",t),t}catch(t){return console.error("getStoredIdentityData - error parsing stored data:",t),{}}};saveIdentityData=()=>{let e={profileId:this.profileId,deviceId:this.deviceId,userId:this.userId||""};console.log("saveIdentityData - saving data:",e),localStorage.setItem(this.CDP_STORAGE_KEY,JSON.stringify(e)),console.log("saveIdentityData - saved to localStorage")};createProfileId=()=>{let e=(0,I.v4)();return console.log("createProfileId - generated:",e),e};createDeviceId=()=>{let e=(0,I.v4)();return console.log("createDeviceId - generated:",e),e};getIdentityData=()=>({profileId:this.profileId,deviceId:this.deviceId,userId:this.userId||""});getProfileId=()=>this.profileId;getDeviceId=()=>this.deviceId;getUserId=()=>this.userId||"";sendPayload=async e=>{let t=new XMLHttpRequest;t.open("POST",`${this.config.cdpEndpoint.endsWith("/")?this.config.cdpEndpoint:`${this.config.cdpEndpoint}/`}analyze/analyze.php`,!0),t.withCredentials=!0,t.onload=()=>{t.status>=200&&t.status<300?console.info("Payload sent successfully:",t.responseText):console.error(`API responded with status ${t.status}:`,t.responseText)},t.onerror=i=>{console.error("Request error:",i)},t.send(JSON.stringify(e))}},te=class{sessionId=null;inactivityTimeout;inactivityTimer=null;SESSION_DATA="hclcdp_session";onSessionStart;onSessionEnd;constructor(e,t,i){this.inactivityTimeout=(e.inactivityTimeout||30)*60*1e3,this.onSessionStart=t||(n=>{console.log(`Default: Session started with ID: ${n}`)}),this.onSessionEnd=i||(n=>{console.log(`Default: Session ended with ID: ${n}`)}),this.initializeSession(),this.setupActivityListeners()}initializeSession(){let e=this.getSessionData();e&&this.isSessionValid(e)?(this.sessionId=e.sessionId,this.resetInactivityTimer()):this.startNewSession()}getSessionData(){let e=localStorage.getItem(this.SESSION_DATA);return e?JSON.parse(e):null}saveSessionData(e){localStorage.setItem(this.SESSION_DATA,JSON.stringify(e))}isSessionValid(e){return Date.now()-e.lastActivityTimestamp<this.inactivityTimeout}generateSessionId(){return(0,_.v4)()}startNewSession(){this.sessionId=this.generateSessionId();let e={sessionId:this.sessionId,lastActivityTimestamp:Date.now(),sessionStartTimestamp:Date.now()};this.saveSessionData(e),this.resetInactivityTimer(),this.onSessionStart(this.sessionId)}resetInactivityTimer(){this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(()=>{this.endSession()},this.inactivityTimeout);let e=this.getSessionData();e&&(e.lastActivityTimestamp=Date.now(),this.saveSessionData(e))}endSession(){localStorage.removeItem(this.SESSION_DATA),this.sessionId&&this.onSessionEnd(this.sessionId),this.sessionId=null}setupActivityListeners(){["mousemove","keydown","scroll"].forEach(e=>{window.addEventListener(e,()=>this.resetInactivityTimer())})}getSessionId(){return this.sessionId}forceNewSession(){this.sessionId&&this.endSession(),this.startNewSession()}},ie=class w{static PAGE_QUEUE_KEY="hcl_cdp_page_queue";static TRACK_QUEUE_KEY="hcl_cdp_track_queue";static IDENTIFY_QUEUE_KEY="hcl_cdp_identify_queue";static addToQueue(t,i){let n=this.getQueue(t);n.push(i),localStorage.setItem(t,JSON.stringify(n))}static getQueue(t){let i=localStorage.getItem(t);return i?JSON.parse(i):[]}static clearQueue(t){localStorage.removeItem(t)}static flushQueue(t,i){this.getQueue(t).forEach(n=>{try{switch(t){case w.PAGE_QUEUE_KEY:i(n.pageName,n.properties,n.otherIds);break;case w.TRACK_QUEUE_KEY:i(n.eventName,n.properties,n.otherIds);break;case w.IDENTIFY_QUEUE_KEY:i(n.userId,n.properties,n.otherIds);break}}catch(o){console.error(`Error flushing ${t} event:`,o)}}),this.clearQueue(t)}},l=ie,r=class s{static instance;cdpClient=null;static deviceId=null;sessionId=null;sessionManager=null;static config={writeKey:"",cdpEndpoint:"",inactivityTimeout:30,enableSessionLogging:!1,enableUserLogoutLogging:!1};static destinations=[];constructor(){}static async init(t,i){this.destinations=t.destinations||[];for(let n of this.destinations)n.instance=new n.classRef,await n.instance.init(n.config);s.instance||(s.instance=new s),this.config={writeKey:t.writeKey,cdpEndpoint:t.cdpEndpoint,inactivityTimeout:t.inactivityTimeout||30,enableSessionLogging:t.enableSessionLogging===!0,enableUserLogoutLogging:t.enableUserLogoutLogging===!0,destinations:t.destinations||[]},s.instance.cdpClient=new ee,await s.instance.cdpClient.init(t);try{l.flushQueue(l.PAGE_QUEUE_KEY,s.instance.cdpClient.page.bind(s.instance.cdpClient)),l.flushQueue(l.TRACK_QUEUE_KEY,s.instance.cdpClient.track.bind(s.instance.cdpClient)),l.flushQueue(l.IDENTIFY_QUEUE_KEY,s.instance.cdpClient.identify.bind(s.instance.cdpClient)),s.instance.sessionManager=new te(t,s.onSessionStart,s.onSessionEnd),typeof window<"u"&&(window.HclCdp?console.warn("window.HclCdp is already defined. Skipping attachment."):window.HclCdp=s);let n={};["_ga","_fbc","_fbp","mcmid"].forEach(o=>{let a=this.getCookie(o);a&&(n[o]=a)}),i&&i(null,{deviceId:s.getDeviceId()||null,sessionId:s.getSessionId()||null})}catch(n){console.log("Error initializing HCL CDP SDK:",n),i&&i(n)}}static onSessionStart=t=>{this.config?.enableSessionLogging===!0&&(s.instance?.cdpClient?s.instance.cdpClient.track("Session_Start",t):l.addToQueue(l.TRACK_QUEUE_KEY,{sessionId:t,eventName:"Session_Start",properties:{},otherIds:{}}))};static onSessionEnd=t=>{this.config?.enableSessionLogging===!0&&s.instance?.cdpClient&&s.instance.cdpClient.track("Session_End",t)};static page=async(t,i,n)=>{let o={sessionId:this.getSessionId(),pageName:t,properties:{...i,path:window.location.pathname,url:window.location.href,referrer:document.referrer,title:document.title,search:document.location.search},otherIds:n};if(this.destinations.forEach(S=>{S.instance.page({event:t,properties:o.properties})}),!s.instance||!s.instance.cdpClient){console.log("adding to queue"),l.addToQueue(l.PAGE_QUEUE_KEY,o);return}let a=this.parseUtmParameters(document.location.pathname);s.instance.cdpClient.page(t,this.getSessionId(),o.properties,a,n)};static track=async(t,i,n)=>{this.destinations.forEach(a=>{a.instance.track({event:t,properties:i})});let o={sessionId:this.getSessionId(),eventName:t,properties:i,otherIds:n};if(!s.instance||!s.instance.cdpClient){l.addToQueue(l.TRACK_QUEUE_KEY,o);return}s.instance.cdpClient.track(t,this.getSessionId(),i,n)};static identify=async(t,i,n)=>{this.destinations.forEach(a=>{a.instance.identify({properties:i})});let o={sessionId:this.getSessionId(),userId:t,properties:i,otherIds:n};if(!s.instance||!s.instance.cdpClient){l.addToQueue(l.IDENTIFY_QUEUE_KEY,o);return}s.instance.cdpClient.identify(t,this.getSessionId(),i,n)};static getDeviceId(){return s.instance?.cdpClient?.deviceId||""}static getProfileId(){return s.instance?.cdpClient?.profileId||""}static getUserId(){return s.instance?.cdpClient?.userId||""}static getIdentityData(){return s.instance?.cdpClient?s.instance.cdpClient.getIdentityData():null}static getSessionId(){return s.instance?.sessionManager?.getSessionId()||""}static logout=async()=>{s.instance?.cdpClient&&(this.config.enableUserLogoutLogging?s.instance.cdpClient.logout(this.getSessionId()):s.instance.cdpClient.logout(this.getSessionId()),s.instance.sessionManager&&s.instance.sessionManager.forceNewSession())};static parseUtmParameters=t=>{try{let i=/(?:\?|&)(utm_[^=]+)=(.*?)(?=&|$)/gi,n={},o;for(;(o=i.exec(document.URL))!==null;)n[o[1]]=o[2];return n}catch(i){return console.error("Error parsing UTM parameters:",i),{}}};static getCookie=t=>{let i=`; ${document.cookie}`.split(`; ${t}=`);return i.length===2?i.pop()?.split(";").shift()??"":""}},R=class{facebookPixelId;async init(e){if(!e||!e.pixelId){console.error("Facebook Pixel ID is not provided.");return}this.facebookPixelId=e.pixelId;let t="facebookPixel";if(document.getElementById(t))return console.warn("Facebook Pixel script is already loaded."),Promise.resolve();{window._fbq=window._fbq||function(...o){window.fbq.callMethod?window.fbq.callMethod.apply(window.fbq,o):window.fbq.queue.push(o)},window.fbq=window.fbq||window._fbq,window.fbq.push=window.fbq,window.fbq.loaded=!0,window.fbq.disablePushState=!0,window.fbq.allowDuplicatePageViews=!0,window.fbq.version="2.0",window.fbq.queue=[],console.debug("===In Facebook init==="),window.fbq("init",this.facebookPixelId);let i=document.createElement("script");i.type="text/javascript",i.id=t,i.async=!0,i.src="https://connect.facebook.net/en_US/fbevents.js";let n=document.getElementsByTagName("script")[0];return n&&n.parentNode&&n.parentNode.insertBefore(i,n),new Promise((o,a)=>{i.onload=()=>{console.info("Facebook Pixel has been successfully initialized."),o()},i.onerror=()=>{console.error("Failed to load Facebook Pixel script."),a(new Error("Failed to load Facebook Pixel script."))}})}}track(e){console.log("===In Facebook track==="),typeof window.fbq=="function"?window.fbq("track",e.event,e.properties):console.error("Facebook Pixel is not initialized. Did you call init()?")}page(e){console.log("===In Facebook page==="),typeof window.fbq=="function"?window.fbq("track","PageView",e.properties):console.error("Facebook Pixel is not initialized. Did you call init()?")}identify(e){console.log("===In Facebook identify==="),typeof window.fbq=="function"?window.fbq("track","Identify",e.properties):console.error("Facebook Pixel is not initialized. Did you call init()?")}},L=class{async init(e){if(!e||!e.measurementId){console.error("Google Analytics measurementId is not provided.");return}let t="google-analytics-4";if(document.getElementById(t))return console.warn("Google Analytics script is already loaded."),Promise.resolve();{let i=document.createElement("script");return i.src=`https://www.googletagmanager.com/gtag/js?id=${e.measurementId}&l=ga4DataLayer`,i.async=!0,i.type="text/javascript",i.id=t,document.getElementsByTagName("head")[0].appendChild(i),new Promise((n,o)=>{i.onload=()=>{console.debug("===GA4 script loaded==="),window.ga4DataLayer=window.ga4DataLayer||[],window.gtag=function(...a){window.ga4DataLayer.push(a)},window.gtag("js",new Date),window.gtag("config",e.measurementId),console.info("Google Analytics has been successfully initialized."),n()},i.onerror=()=>{console.error("Failed to load Google Analytics script."),o(new Error("Failed to load Google Analytics script."))}})}}track(e){console.log("===In GA4 track===",e),window.gtag("event",e.event,e.properties)}page(e){console.log("===In GA4 page===",e),window.gtag("event",e.event,e.properties)}identify(e){console.log("===In GA4 identify==="),window.gtag("set","user_properties",e.properties)}};var c=require("react");var u=require("react"),N=require("react/jsx-runtime"),K=(0,u.createContext)(null),T=({children:e})=>{let[t,i]=(0,u.useState)("page"),[n,o]=(0,u.useState)({});return(0,N.jsx)(K.Provider,{value:{eventIdentifier:t,setEventIdentifier:i,pageProperties:n,setPageProperties:o},children:e})},ne=()=>{let e=(0,u.useContext)(K);if(!e)throw new Error("useCdpContext must be used within a CdpProvider");return e};var k=require("react/jsx-runtime"),q=(0,c.createContext)({isReady:!1,page:function(e){},track:function(e){},identify:function(e){},logout:function(){},setEventIdentifier:(()=>{}),setPageProperties:(()=>{}),getIdentityData:()=>null,getProfileId:()=>"",getDeviceId:()=>"",getUserId:()=>""}),x=({config:e,children:t})=>{let[i,n]=(0,c.useState)(!1),[o,a]=(0,c.useState)("page"),[S,Q]=(0,c.useState)({}),A=(0,c.useRef)(!1),E=(0,c.useRef)([]),C=(0,c.useRef)([]),D=(0,c.useRef)([]);(0,c.useEffect)(()=>{if(!(typeof window>"u")&&!A.current){if(!e.writeKey){console.error("CdpProvider: Missing writeKey");return}r.init(e,(g,p)=>{g?console.error("CDPProvider initialization failed:",g):(A.current=!0,n(!0),E.current.forEach(({identifier:d,properties:f,otherIds:h})=>{r.page(d,f,h)}),E.current=[],C.current.forEach(({identifier:d,properties:f,otherIds:h})=>{r.track(d,f,h)}),C.current=[],D.current.forEach(({identifier:d,properties:f,otherIds:h})=>{r.identify(d,f,h)}),D.current=[])})}},[e.writeKey]);let F=({identifier:g=o,properties:p=S,otherIds:d={}})=>{i?r.page(g,p,d):E.current.push({identifier:g,properties:p,otherIds:d})},Y=({identifier:g,properties:p={},otherIds:d={}})=>{i?r.track(g,p,d):C.current.push({identifier:g,properties:p,otherIds:d})},G=({identifier:g,properties:p={},otherIds:d={}})=>{i?r.identify(g,p,d):D.current.push({identifier:g,properties:p,otherIds:d})},j=()=>{i&&r.logout()},z=()=>r.getIdentityData?r.getIdentityData():{profileId:r.getProfileId?.()||r.getDeviceId()||"",deviceId:r.getDeviceId?.()||"",userId:r.getUserId?.()||""},H=()=>r.getProfileId?r.getProfileId():r.getDeviceId(),V=()=>r.getDeviceId?r.getDeviceId():"",M=()=>r.getUserId?r.getUserId():"";return(0,k.jsx)(T,{children:(0,k.jsx)(q.Provider,{value:{isReady:i,page:F,track:Y,identify:G,logout:j,setEventIdentifier:a,setPageProperties:Q,getIdentityData:z,getProfileId:H,getDeviceId:V,getUserId:M},children:t})})},U=()=>(0,c.useContext)(q);var v=require("react/jsx-runtime"),oe=({config:e,children:t})=>e.writeKey&&e.cdpEndpoint?(0,v.jsx)(x,{config:e,children:t}):(console.warn("CDP: Invalid configuration detected. Tracking disabled."),(0,v.jsx)(v.Fragment,{children:t}));var m=require("react");var se=({pageName:e,pageProperties:t={}})=>{let{page:i}=U(),n=(0,m.useRef)(void 0),o=(0,m.useRef)(void 0);return(0,m.useEffect)(()=>{let a=JSON.stringify(t);(n.current!==e||o.current!==a)&&(i({identifier:e||"",properties:t,otherIds:{}}),n.current=e,o.current=a)},[e,t,i]),null};0&&(module.exports={CdpClientWrapper,CdpContextProvider,CdpPageEvent,CdpProvider,Facebook,GoogleAnalytics,useCdp,useCdpContext});
